image: ghcr.io/astral-sh/uv:0.6.10-python3.13-alpine

variables:
    CACHE_DIR: $CI_PROJECT_DIR/.cache
    UV_CACHE_DIR: $CACHE_DIR/uv
    PYRIGHT_PYTHON_CACHE_DIR: $CACHE_DIR/pyright

stages:
    - test
    - publish
    - version

test:
    stage: test
    image: ghcr.io/astral-sh/uv:0.6.10-python3.13-bookworm-slim
    cache:
        paths:
            - $CACHE_DIR
    script:
        - uv sync --group dev
        - source .venv/bin/activate
        - ruff check
        - pyright
        - python test --expect-full

publish:
    stage: publish
    only:
        - main
    script:
        - uv build
        - uv publish --username __token__

version:
    stage: version
    only:
        - main
    script:
        - apk add git
        - uvx uv-glci-bump-version patch --access-token $ACCESS_TOKEN
