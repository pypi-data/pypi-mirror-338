image: continuumio/anaconda3

stages:
  - test
  - deploy

test_mpitest_openmpi:
    image: registry.windenergy.dtu.dk/hawc2/hawc2lib:mpi
    variables:
      GIT_SUBMODULE_STRATEGY: recursive # need to checkout hawc2 and utils
    script:
    - pip install .[test]
    - pytest --cov-report term-missing:skip-covered --cov=multiclass_interface multiclass_interface/tests
    rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    tags: 
    - ci-ubuntu


# ===== Check code style =====
check_code_style:  # name the job what we like
  stage:  # build, test, deploy defined by default [2]
    test
  script:
  - pip install -e . --user
  - pycodestyle --ignore=E501,W504,E741 multiclass_interface
  tags:  # only runners with this tag can do the job [3]
  - ci-ubuntu
  rules:
  - if: $CI_COMMIT_BRANCH == "main"
  - if: $CI_PIPELINE_SOURCE == "merge_request_event"


pypi_linux:
  stage:
    deploy
  script:
    - apt-get update
    #- apt-get install -y pandoc
    - pip install --upgrade pip
    #- pip install pypandoc
    - pip install -e . --upgrade
    - pip install --upgrade build
    - pip install twine packaging --upgrade 
    - python3 -m build
    - twine upload dist/* -u $TWINE_USERNAME -p $TWINE_PASSWORD
  rules:
    - if: $CI_COMMIT_TAG && $CI_COMMIT_REF_PROTECTED
    - if:  $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
      allow_failure: true
    - when: never
  tags:
  - ci-ubuntu
