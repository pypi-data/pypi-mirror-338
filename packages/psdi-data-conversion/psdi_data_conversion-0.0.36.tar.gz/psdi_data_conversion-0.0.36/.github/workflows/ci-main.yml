# Workflow for continuous integration tasks triggered on pushes to main

name: CI - Main
run-name: CI - Main
on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  test-python:
    uses: ./.github/workflows/job-test-python.yml
  test-gui:
    uses: ./.github/workflows/job-test-gui.yml

  container-push:
    uses: ./.github/workflows/job-container-push.yml
    needs: [test-python, test-gui]
    with:
      # container_tag
      container_tag: ${{ github.sha }}
  # Deploy to Kubernetes Job
  # Requires an environment, which must reflect the target environment as defined in the
  # GitHub repository: https://github.com/PSDI-UK/psdi-data-conversion/settings/environments
  # The downstream deploy job leverages on Environment specific secrets, which also must be defined
  # For the tag, we need something unique for each push, so we use the SHA of the latest commit
  deploy-stfc-dev-k8s:
    needs: [container-push]
    uses: ./.github/workflows/job-deploy-k8s.yml # use the callable deploy job
    secrets: inherit # pass all secrets for the environment
    with:
      # container_tag
      container_tag: ${{ github.sha }}
      environment: development
