image: registry.forge.ird.fr/diade/culebront_pipeline/podman/gitlab-runner:0.0.2 # docker image used
####################
# TAG stages: we define 3 test steps called install, test, deploy
stages:
  - install
  - test
  - deploy
#variables:
#  CI_DEBUG_TRACE: "true"

####################
# TAG before_script : we list all the commands required before running any test. eg.: clone repo, install soft
before_script:
  - echo ${CI_PROJECT_DIR}
  - export PATH=$PATH:/root/.local/bin
  - export APPTAINER_BINDPATH="${CI_PROJECT_DIR}:${CI_PROJECT_DIR},/root:/root"
  #- python3 -m pip install -U snakemake setuptools build pip
  #- python3 -m pip install snakecdysis@git+https://forge.ird.fr/phim/sravel/snakecdysis.git@main
  - python3 -m pip install culebrONT@git+https://forge.ird.fr/diade/culebront_pipeline.git@$CI_COMMIT_REF_NAME
  - culebrONT --install_env
  - bash -ec 'CPDIR="/opt/venv/lib/python3.12/site-packages/culebrONT/containers"; DIR="/usr/local/culebrONT/Containers"; if [[ -d $DIR ]]; then ls $DIR;  echo "copy Containers files in $DIR to $CPDIR"; ln -sf $DIR/* $CPDIR; fi'
  - culebrONT install -m local
  - culebrONT edit_profile & 
  - culebrONT --help


####### COMMON (Install) #######
culebrONT:installing:
  stage: install                       # Put the name of stage defined previously
  script:                              # shell commands executed by the runner
    - culebrONT --install_env
  tags:
    - VM
  rules:                               # Condition if the test is run or not
    - if: $CI_COMMIT_TAG =~ "/^v.*rc/" # Tests ran if commit message start with v.
    - if: $CI_COMMIT_MESSAGE =~ "/.*-TEST.*/i"
    - if: $CI_PIPELINE_SOURCE == "web"  # Add this rule for manual triggers
    - if: $CI_MERGE_REQUEST_ID # run test if is a merge_request


# @Description TEST config_quick
culebrONT:Test_config_quick.yaml:
  stage: test
  artifacts:
    name: culebrONT-config_quick
    paths:
      - test/CulebrONT_OUTPUT
      - /root/.local/lib/python3.10/site-packages/culebrONT
  script:
    - culebrONT --install_env
    - culebrONT test_install -d test
    - culebrONT run --local-cores 22 -c ./culebrONT/install_files/config_test/config_quick.yaml;
  tags:
    - VM
  rules:                               # Condition if the test is run or not
    - if: $CI_COMMIT_TAG =~ "/^v.*rc/" # Tests ran if commit message start with v.
    - if: $CI_COMMIT_MESSAGE =~ "/.*-TEST.*/i"
    - if: $CI_PIPELINE_SOURCE == "web"  # Add this rule for manual triggers
    - if: $CI_MERGE_REQUEST_ID # run test if is a merge_request



# @Description TEST config_A
culebrONT:Test_config_A.yaml:
  stage: test
  artifacts:
    name: culebrONT-logs
    paths:
      - test/CulebrONT_OUTPUT
  script:
    - culebrONT --install_env
    - culebrONT test_install -d test
    - culebrONT run --local-cores 22 -c ./culebrONT/install_files/config_test/config_A.yaml
  tags:
    - VM
  rules:                               # Condition if the test is run or not
    - if: $CI_COMMIT_TAG =~ "/^v.*rc/" # Tests ran if commit message start with v.
    - if: $CI_COMMIT_MESSAGE =~ "/.*-TEST.*/i"
    - if: $CI_PIPELINE_SOURCE == "web"  # Add this rule for manual triggers
    - if: $CI_MERGE_REQUEST_ID # run test if is a merge_request

# @Description TEST config_AC
culebrONT:Test_config_AC.yaml:
  stage: test
  artifacts:
    name: culebrONT-logs-AC
    paths:
        - test/CulebrONT_OUTPUT
  script:
    - culebrONT test_install -d test
    - culebrONT run --local-cores 22 -c ./culebrONT/install_files/config_test/config_AC.yaml
  tags:
    - VM
  rules:                               # Condition if the test is run or not
    - if: $CI_COMMIT_TAG =~ "/^v.*rc/" # Tests ran if commit message start with v.
    - if: $CI_COMMIT_MESSAGE =~ "/.*-TEST.*/i"
    - if: $CI_PIPELINE_SOURCE == "web"  # Add this rule for manual triggers
    - if: $CI_MERGE_REQUEST_ID # run test if is a merge_request

# @Description TEST config_AP
culebrONT:Test_config_AP.yaml:
  stage: test
  artifacts:
    name: culebrONT-logs-AP
    paths:
        - test/CulebrONT_OUTPUT
  script:
    - culebrONT test_install -d test
    - culebrONT run --local-cores 22 -c ./culebrONT/install_files/config_test/config_AP.yaml
  tags:
    - VM
  rules:                               # Condition if the test is run or not
    - if: $CI_COMMIT_TAG =~ "/^v.*rc/" # Tests ran if commit message start with v.
    - if: $CI_COMMIT_MESSAGE =~ "/.*-TEST.*/i"
    - if: $CI_PIPELINE_SOURCE == "web"  # Add this rule for manual triggers
    - if: $CI_MERGE_REQUEST_ID # run test if is a merge_request

# @Description TEST config_APC
culebrONT:Test_config_APC.yaml:
  stage: test
  artifacts:
    name: culebrONT-logs-APC
    paths:
        - test/CulebrONT_OUTPUT
  script:
    - culebrONT test_install -d test
    - culebrONT run --local-cores 22 -c ./culebrONT/install_files/config_test/config_APC.yaml
  tags:
    - VM
  rules:                               # Condition if the test is run or not
    - if: $CI_COMMIT_TAG =~ "/^v.*rc/" # Tests ran if commit message start with v.
    - if: $CI_COMMIT_MESSAGE =~ "/.*-TEST.*/i"
    - if: $CI_PIPELINE_SOURCE == "web"  # Add this rule for manual triggers
    - if: $CI_MERGE_REQUEST_ID # run test if is a merge_request

# @Description TEST config_APCQ-CIRQ
culebrONT:Test_config_APCQ-CIRQ.yaml:
  stage: test
  artifacts:
    name: culebrONT-logs-APCQ-CIRQ
    paths:
      - test/CulebrONT_OUTPUT
  script:
    - culebrONT test_install -d test
    - culebrONT run --local-cores 22 -c ./culebrONT/install_files/config_test/config_APCQ-CIRQ.yaml
  tags:
    - VM
  rules:                               # Condition if the test is run or not
    - if: $CI_COMMIT_TAG =~ "/^v.*rc/" # Tests ran if commit message start with v.
    - if: $CI_COMMIT_MESSAGE =~ "/.*-TEST.*/i"
    - if: $CI_PIPELINE_SOURCE == "web"  # Add this rule for manual triggers
    - if: $CI_MERGE_REQUEST_ID # run test if is a merge_request

# @Description TEST config_APCQ
culebrONT:Test_config_APCQ.yaml:
  stage: test
  artifacts:
    name: culebrONT-logs-APCQ
    paths:
      - test/CulebrONT_OUTPUT
  script:
    - culebrONT test_install -d test
    - culebrONT run --local-cores 22 -c ./culebrONT/install_files/config_test/config_APCQ.yaml
  tags:
    - VM
  rules:                               # Condition if the test is run or not
    - if: $CI_COMMIT_TAG =~ "/^v.*rc/" # Tests ran if commit message start with v.
    - if: $CI_COMMIT_MESSAGE =~ "/.*-TEST.*/i"
    - if: $CI_PIPELINE_SOURCE == "web"  # Add this rule for manual triggers
    - if: $CI_MERGE_REQUEST_ID # run test if is a merge_request

# @Description TEST config_APQ
culebrONT:Test_config_APQ.yaml:
  stage: test
  artifacts:
    name: culebrONT-logs-APQ
    paths:
      - test/CulebrONT_OUTPUT
  script:
    - culebrONT test_install -d test
    - culebrONT run --local-cores 22 -c ./culebrONT/install_files/config_test/config_APQ.yaml
  tags:
    - VM
  rules:                               # Condition if the test is run or not
    - if: $CI_COMMIT_TAG =~ "/^v.*rc/" # Tests ran if commit message start with v.
    - if: $CI_COMMIT_MESSAGE =~ "/.*-TEST.*/i"
    - if: $CI_PIPELINE_SOURCE == "web"  # Add this rule for manual triggers
    - if: $CI_MERGE_REQUEST_ID # run test if is a merge_request
