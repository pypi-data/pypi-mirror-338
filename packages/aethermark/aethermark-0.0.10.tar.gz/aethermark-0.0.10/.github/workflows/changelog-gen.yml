name: Changelog Generation

on:
  push:
    tags:
      - "v*" # Runs when a version tag (e.g., v1.2.3) is pushed

jobs:
  send_changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Version from Tag
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Get Previous Version Tag
        id: previous_tag
        run: |
          PREV_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+' | sed -n '2p')
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)  # First commit if no previous tag
          fi
          echo "PREV_TAG=$PREV_TAG" >> $GITHUB_ENV

      - name: Generate Changelog
        run: |
          echo "## Version $VERSION" > changelog.md
          echo "" >> changelog.md

          declare -A commit_types=(
            [feat]="ðŸš€ Features"
            [fix]="ðŸ›  Fixes"
            [perf]="âš¡ Performance Improvements"
            [refactor]="â™»ï¸ Refactoring"
            [docs]="ðŸ“ Documentation Updates"
            [style]="ðŸŽ¨ Code Style Changes"
            [test]="ðŸ§ª Tests"
            [build]="ðŸ—ï¸ Build Changes"
            [ci]="ðŸ”§ CI/CD"
            [chore]="ðŸ”¨ Miscellaneous"
            [revert]="âª Reverts"
            [release]="ðŸš€ Release Updates"
            [workflow]="âš™ï¸ Workflow Changes"
          )

          HAS_CHANGES=0  # Track if we have at least one section

          for type in "${!commit_types[@]}"; do
            section=${commit_types[$type]}
            commits=$(git log $PREV_TAG..HEAD --grep="^$type:" --pretty=format:"- %h %s (%an, %ad)" --date=format:'%Y-%m-%d %H:%M')

            if [ -n "$commits" ]; then
              echo "### $section" >> changelog.md
              echo "$commits" >> changelog.md
              echo "" >> changelog.md
              HAS_CHANGES=1
            fi
          done

          if [ "$HAS_CHANGES" -eq 0 ]; then
            echo "No relevant commits found for this release. Exiting."
            exit 0
          fi

      - name: Update HISTORY.md
        run: |
          echo "## Version $VERSION" >> HISTORY.md
          echo "" >> HISTORY.md
          cat changelog.md >> HISTORY.md
          echo "" >> HISTORY.md

      - name: Commit and Push Updates
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add HISTORY.md changelog.md
          if git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update changelog and HISTORY.md for version $VERSION"
          git push
