(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[71],{2762:(e,t,s)=>{Promise.resolve().then(s.bind(s,4016))},4016:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>X});var a=s(698),r=s(5155),n=s(2115),i=s(5285),l=s(9219),o=s(8525),d=s(7980),c=s(9757),u=s(5055),f=s(1522),g=s(6588);function h(){let e=(0,a._)(["\n  position: fixed;\n  top: 0;\n  left: 80px;\n  right: 300px;  \n  bottom: 0;\n  background-color: var(--neutral-900);\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  z-index: 1000;\n"]);return h=function(){return e},e}function m(){let e=(0,a._)(["\n  position: relative;\n  width: 100%;\n  height: 100%;\n  overflow: hidden;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n"]);return m=function(){return e},e}function y(){let e=(0,a._)(["\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  overflow: hidden;\n  max-width: 100%;\n  max-height: 100%;\n"]);return y=function(){return e},e}function v(){let e=(0,a._)(["\n  /* 화면(오버레이) 내부에 맞추기 */\n  max-width: calc(100vw - 300px);\n  max-height: 100vh;\n  object-fit: contain;\n  user-select: none;\n  -webkit-user-drag: none;\n"]);return v=function(){return e},e}function p(){let e=(0,a._)(["\n  position: absolute;\n  pointer-events: none;\n"]);return p=function(){return e},e}function x(){let e=(0,a._)(["\n  position: absolute;\n  bottom: 20px;\n  left: 50%;\n  transform: translateX(-50%);\n  border-radius: 14px;\n  background: rgba(0, 0, 0, 0.30);\n  display: flex;\n  gap: 8px;\n  z-index: 1100;\n  padding: 4px;\n"]);return x=function(){return e},e}function I(){let e=(0,a._)(["\n  display: flex;\n  gap: 8px;\n"]);return I=function(){return e},e}function b(){let e=(0,a._)(["\n  width: 56px;\n  height: 56px;\n  border: none;\n  background: ",";\n  border-radius: 12px;\n  cursor: pointer;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  color: ",";\n  transition: background-color 0.3s;\n  &:hover {\n    background-color: ",";\n  }\n"]);return b=function(){return e},e}function w(){let e=(0,a._)(["\n  width: 18px;\n  height: 18px;\n  flex-shrink: 0;\n  border-radius: 4px;\n  border: 3px solid ",";\n"]);return w=function(){return e},e}function E(){let e=(0,a._)(["\n  position: absolute;\n  top: 16px;\n  right: 16px;\n  width: 48px;\n  height: 48px;\n  background: rgba(0, 0, 0, 0.30);\n  color: white;\n  border-radius: 8px;\n  z-index: 1100; /* Add a high z-index here */\n  &:hover {\n    background: rgba(0, 0, 0, 0.40);\n  }\n"]);return E=function(){return e},e}let C=i.Ay.div(h()),k=i.Ay.div(m()),S=i.Ay.div(y()),j=i.Ay.img(v()),D=i.Ay.canvas(p()),A=i.Ay.div(x()),L=i.Ay.div(I()),M=i.Ay.button(b(),e=>{let{$active:t}=e;return t?"var(--accent)":"white"},e=>{let{$active:t}=e;return t?"white":"var(--color-black)"},e=>{let{$active:t}=e;return t?"var(--accent)":"var(--accent-hover)"}),P=i.Ay.div(w(),e=>{let{$active:t}=e;return t?"white":"#000"}),_=(0,i.Ay)(M)(E()),O=function(e){let{image:t,classes:s,labels:a,saveLabels:i,onClose:l}=e,[o,d]=(0,n.useState)(t.boundingBoxes||[]),[h,m]=(0,n.useState)(t.points||[]),[y,v]=(0,n.useState)(t.segmentations||[]),[p,x]=(0,n.useState)(!1),[I,b]=(0,n.useState)(null),[w,E]=(0,n.useState)("bbox"),O=(0,n.useRef)(null),R=(0,n.useRef)(null),B=(0,n.useRef)(null),z=(0,n.useRef)(t),U=(0,n.useRef)([]),W=(0,n.useRef)([]),N=(0,n.useRef)([]),T=(0,g.M)(),V=t.fileLocation?"".concat(T,"/").concat(t.fileLocation):null;(0,n.useEffect)(()=>{var e,s,r;d((null===(e=a[t.id])||void 0===e?void 0:e.boundingBoxes)||[]),m((null===(s=a[t.id])||void 0===s?void 0:s.keyPoints)||[]),v((null===(r=a[t.id])||void 0===r?void 0:r.segmentations)||[])},[t.id,a]),(0,n.useEffect)(()=>{z.current=t},[t]),(0,n.useEffect)(()=>{U.current=o},[o]),(0,n.useEffect)(()=>{W.current=h},[h]),(0,n.useEffect)(()=>{N.current=y},[y]),(0,n.useEffect)(()=>()=>{i({imageId:t.id,boundingBoxes:U.current,keyPoints:W.current,segmentations:N.current})},[t.id]),(0,n.useEffect)(()=>{function e(){let e=R.current,t=B.current;if(!e||!t)return;let s=t.offsetWidth,a=t.offsetHeight;e.width=s,e.height=a;let r=e.getContext("2d");r.clearRect(0,0,s,a),X(r)}return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[t,o,h,y]);let X=e=>{let{width:t,height:a}=e.canvas;o.forEach(r=>{let n=Object.values(s).find(e=>e.id===r.classId);e.strokeStyle=(null==n?void 0:n.color)||"grey",e.lineWidth=2;let i=r.xMin*t,l=r.yMin*a,o=r.xMax*t,d=r.yMax*a;e.strokeRect(i,l,o-i,d-l)}),h.forEach(r=>{let n=Object.values(s).find(e=>e.id===r.classId),i=(null==n?void 0:n.color)||"grey";e.beginPath(),e.arc(r.x*t,r.y*a,7,0,2*Math.PI),e.strokeStyle="black",e.lineWidth=2,e.stroke(),e.beginPath(),e.arc(r.x*t,r.y*a,5,0,2*Math.PI),e.fillStyle=i,e.fill()}),y.forEach(s=>{s.circles.forEach(r=>{e.beginPath(),e.arc(r.x*t,r.y*a,10,0,2*Math.PI),e.fillStyle=s.color,e.fill()})})},$=e=>{let t=R.current;if(!t)return{x:0,y:0};let s=t.getBoundingClientRect();return{x:e.clientX-s.left,y:e.clientY-s.top}};return(0,r.jsxs)(C,{onMouseDown:e=>{if(0===t.classIds.length)return;let a=R.current;if(!a)return;let{x:r,y:n}=$(e);if("bbox"===w)x(!0),b({x:r,y:n});else if("point"===w){let e=r/a.width,s=n/a.height;m(a=>[...a,{x:e,y:s,classId:t.classIds[0]}])}else if("segmentation"===w){x(!0);let e=r/a.width,i=n/a.height,l=s[t.classIds[0]],o=(null==l?void 0:l.color)||"green";v(t=>[...t,{color:o,circles:[{x:e,y:i}]}])}},onMouseMove:e=>{let a=R.current;if(!a)return;let r=a.getContext("2d");r.clearRect(0,0,a.width,a.height),X(r);let{x:n,y:i}=$(e),l=s[t.classIds[0]],o=(null==l?void 0:l.color)||"grey";if(r.setLineDash([5,5]),r.strokeStyle=o,r.lineWidth=1,r.beginPath(),r.moveTo(0,i),r.lineTo(a.width,i),r.stroke(),r.beginPath(),r.moveTo(n,0),r.lineTo(n,a.height),r.stroke(),r.setLineDash([]),"bbox"===w&&p&&I)r.strokeStyle=o,r.lineWidth=2,r.strokeRect(I.x,I.y,n-I.x,i-I.y);else if("segmentation"===w&&p){let e=n/a.width,t=i/a.height;v(s=>{let a=[...s],r=a[a.length-1];return r&&r.circles.push({x:e,y:t}),a}),r.clearRect(0,0,a.width,a.height),X(r)}"segmentation"===w&&(r.save(),r.globalAlpha=.5,r.fillStyle=o,r.beginPath(),r.arc(n,i,10,0,2*Math.PI),r.fill(),r.restore())},onMouseUp:e=>{if("bbox"===w&&p&&I){let s=R.current;if(!s)return;let{x:a,y:r}=$(e),n=Math.min(I.x,a),i=Math.min(I.y,r),l=Math.max(I.x,a),o=Math.max(I.y,r);if(l-n<5||o-i<5){x(!1),b(null);return}let c=n/s.width,u=i/s.height,f=l/s.width,g=o/s.height;d(e=>[...e,{xMin:c,yMin:u,xMax:f,yMax:g,classId:t.classIds[0]}]),x(!1),b(null)}"segmentation"===w&&x(!1)},children:[(0,r.jsx)(_,{onClick:l,children:(0,r.jsx)(f.o0,{height:"17",width:"17"})}),(0,r.jsxs)(k,{ref:O,children:[(0,r.jsxs)(S,{children:[(0,r.jsx)(j,{ref:B,src:V,alt:"Zoomed"}),(0,r.jsx)(D,{ref:R})]}),(0,r.jsxs)(A,{children:[(0,r.jsxs)(L,{children:[(0,r.jsx)(M,{onClick:()=>E("bbox"),$active:"bbox"===w,children:(0,r.jsx)(P,{$active:"bbox"===w})}),(0,r.jsx)(M,{onClick:()=>E("point"),$active:"point"===w,children:(0,r.jsx)(c.g,{icon:u.nXi,style:{fontSize:"20px"}})})]}),(0,r.jsx)("div",{style:{width:"16px"}}),(0,r.jsx)(M,{onClick:()=>{d([]),m([]),v([])},children:(0,r.jsx)(f.Bh,{})})]})]})]})};var R=s(9827),B=s(3697),z=s(628);let U=(0,R.v)((e,t)=>({datasets:{},classes:{},images:{},labels:{},loadDataset:async()=>{try{let t=await (0,z.yA)(),s=Object.fromEntries(t.map(e=>[e.id,e]));e(e=>({datasets:s,classes:e.classes,images:e.images}))}catch(e){console.error("Error loading initial datasets:",e)}},loadClasses:async()=>{try{let t=await (0,z.tD)(),s=Object.fromEntries(t.map(e=>[e.id,e]));e(e=>({...e,classes:s}))}catch(e){console.error("Error loading classes:",e)}},loadImages:async function(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];try{let a=await (0,z.v8)(s),r=Object.fromEntries(a.map(e=>[e.id,e]));e(e=>({...e,images:r})),await t().loadLabels()}catch(e){console.error("Error loading images:",e)}},loadLabels:async function(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];if(0===s.length)return;let{labels:a}=t(),r={...a};await Promise.all(s.map(async e=>{try{let t=await (0,z.ME)(e);r[e]={boundingBoxes:t.boundingBoxes||[],keyPoints:t.keyPoints||[],segmentations:t.segmentations||[]}}catch(t){console.error("❌ Error loading labels for image ".concat(e,":"),t)}})),e(e=>({...e,labels:r}))},getActiveImages:e=>{let{images:s}=t();return Object.values(s).filter(t=>t.datasetIds.some(t=>e.includes(t)))},saveDataset:async s=>{let{id:a}=s,r=t().datasets[a];try{let t;if(r){let e={name:s.name,description:s.description};if((t=await (0,z.ar)(a,e)).error){console.error("Update dataset failed:",t.error);return}}else{let e={id:a,name:s.name,description:s.description||""};if((t=await (0,z.ar)(e)).error){console.error("Create dataset failed:",t.error);return}}e(e=>{let{classIds:t=[],imageIds:r=[]}=s,n={...e.datasets,[a]:{...e.datasets[a],...s,classIds:t,imageIds:r}};return{...e,datasets:n}})}catch(e){console.error("saveDataset error:",e)}},deleteDataset:async t=>{try{let s=await (0,z.gu)(t);if(s.error){console.error("Delete dataset failed:",s.error);return}e(e=>{if(!e.datasets[t])return e;let s={...e.classes},a={...e.images};Object.keys(s).forEach(e=>{s[e].datasetIds&&(s[e]={...s[e],datasetIds:s[e].datasetIds.filter(e=>e!==t)})}),Object.keys(a).forEach(e=>{a[e].datasetIds&&(a[e]={...a[e],datasetIds:a[e].datasetIds.filter(e=>e!==t)})});let r={...e.datasets};return delete r[t],{...e,datasets:r,classes:s,images:a}})}catch(e){console.error("deleteDataset error:",e)}},saveClass:async s=>{let a;let{id:r}=s;if(t().classes[r]){let e={name:s.name,color:s.color||"#CCCCCC",dataset_ids:s.datasetIds||[],image_ids:s.imageIds||[]};if((a=await (0,z.S3)(r,e)).error){console.error("Update class failed:",a.error);return}}else{let e={id:r,name:s.name,color:s.color||"#CCCCCC",dataset_ids:s.datasetIds||[],image_ids:s.imageIds||[]};if((a=await (0,z.S3)(r,e)).error){console.error("Create class failed:",a.error);return}}e(e=>{let t={...e.classes,[r]:a},s=a.datasetIds||[],n={...e.datasets};s.forEach(e=>{if(n[e]){let t=n[e].classIds||[];n[e].classIds=[...new Set([...t,r])]}});let i=a.imageIds||[],l={...e.images};return i.forEach(e=>{l[e]&&(l[e].classIds=[r])}),{...e,classes:t,datasets:n,images:l}})},deleteClass:async t=>{try{let s=await (0,z._p)(t);if(s.error){console.error("Delete class failed:",s.error);return}e(e=>{if(!e.classes[t])return e;let s={...e.datasets},a={...e.images};Object.keys(s).forEach(e=>{s[e].classIds&&(s[e]={...s[e],classIds:s[e].classIds.filter(e=>e!==t)})}),Object.keys(a).forEach(e=>{a[e].classIds&&(a[e]={...a[e],classIds:a[e].classIds.filter(e=>e!==t)})});let r={...e.classes};return delete r[t],{...e,classes:r,datasets:s,images:a}})}catch(e){console.error("deleteClass error:",e)}},saveImage:async s=>{let{id:a}=s;try{var r,n;let i={...(null===(r=t().images[a])||void 0===r?void 0:r.properties)||{description:"",comment:""},...s.properties},l={...(null===(n=t().images[a])||void 0===n?void 0:n.model)||{},...s.model},o={id:a,filename:s.filename||"untitled.png",fileLocation:s.fileLocation||"",thumbnailLocation:s.thumbnailLocation||"",datasetIds:s.datasetIds||[],classIds:s.classIds||[],approval:s.approval||"pending",comment:s.comment||"",height:s.height||null,width:s.width||null,type:s.type||null,size:s.size||null,properties:i},d=await (0,z.LO)(a,o);if(d.error){console.error("Upsert image failed:",d.error);return}let c={};await Promise.all(o.datasetIds.map(async e=>{try{let t=await (0,z.vh)(e);t.error?console.error("Failed to fetch updated dataset from server:",t.error):c[e]=t}catch(e){console.error("Error fetching updated dataset from server:",e)}})),e(e=>{let{datasetIds:t=[],classIds:s=null}=o,r={...e.images,[a]:{...e.images[a],...o,datasetIds:t,classIds:s,model:l}},n={...e.datasets,...c},i={...e.classes};return e.images[a]&&(e.images[a].datasetIds||[]).forEach(e=>{n[e]&&(n[e]={...n[e],imageIds:n[e].imageIds.filter(e=>e!==a)})}),t.forEach(e=>{n[e]&&(n[e]={...n[e],imageIds:[...new Set([...n[e].imageIds,a])]})}),{...e,images:r,datasets:n,classes:i}})}catch(e){console.error("saveImage error:",e)}},deleteImage:async(t,s)=>{try{let a=await (0,z.vS)(t,s);if(a.error){console.error("Delete image failed:",a.error);return}e(e=>{if(!e.images[t])return e;let s={...e.datasets},a={...e.classes};Object.keys(s).forEach(e=>{s[e].imageIds&&(s[e]={...s[e],imageIds:s[e].imageIds.filter(e=>e!==t)})}),Object.keys(a).forEach(e=>{a[e].imageIds&&(a[e]={...a[e],imageIds:a[e].imageIds.filter(e=>e!==t)})});let r={...e.images};return delete r[t],{...e,images:r,datasets:s,classes:a}})}catch(e){console.error("deleteImage error:",e)}},createDataset:async(t,s)=>{let a={id:(0,B.A)(),name:t,description:"Newly created dataset",classIds:[],imageIds:[],uploadedAt:new Date().toISOString(),updatedAt:new Date().toISOString(),createdBy:s||""};try{let t=await (0,z.z8)(a);if(!t.error)return e(e=>({datasets:{...e.datasets,[t.id]:{...t,classIds:[],imageIds:[]}}})),t.id;return console.error("Dataset creation failed:",t.error),null}catch(e){return console.error("API Error (createDataset):",e),null}},createClass:(e,s,a,r)=>{let n=(0,B.A)();return t().saveClass({id:n,name:e,datasetIds:s||[],imageIds:a||[],color:"#CCCCCC",createdAt:new Date().toISOString(),createdBy:r||""}),n},createImage:async(t,s,a)=>{let r=(await Promise.all(t.map(async e=>{let t=(0,B.A)(),r={id:t,filename:e.file.name,width:e.width||0,height:e.height||0,datasetIds:s||[],classId:null,properties:[],imageURL:URL.createObjectURL(e.file),uploadedAt:new Date().toISOString(),updatedAt:new Date().toISOString(),model:{},approval:"pending",comment:"",labeledBy:a||"",editedBy:a||"",uploadedBy:a||""};try{let a=await apiCreateImage(t,e.file,"user1",s);if(!a||a.error)return console.error("Create image failed:",a.error),null;return{...r,id:a.id,imageURL:a.imageURL}}catch(e){return console.error("API Error (createImage):",e),null}}))).filter(e=>null!==e);0!==r.length&&(await Promise.all(s.map(async t=>{try{let s=await (0,z.vh)(t);s.error?console.error("Failed to fetch updated dataset from server:",s.error):e(e=>({...e,datasets:{...e.datasets,[t]:s}}))}catch(e){console.error("Error fetching updated dataset from server:",e)}})),e(e=>{let t={...e.images},s={...e.datasets};return r.forEach(e=>{t[e.id]=e,e.datasetIds.forEach(t=>{s[t]&&(s[t]={...s[t],imageIds:[...new Set([...s[t].image_ids,e.id])]})})}),{...e,images:t,datasets:s}}))},saveLabels:async t=>{let{imageId:s,boundingBoxes:a=[],keyPoints:r=[],segmentations:n=[]}=t;try{console.log("Saving Labels:",s,a);let t=await (0,z.zg)({imageId:s,boundingBoxes:a,keyPoints:r,segmentations:n});e(e=>({images:{...e.images,[s]:{...e.images[s],boundingBoxes:t.boundingBoxes||a,keyPoints:t.keyPoints||r,segmentations:t.segmentations||n}}})),console.log("✅ Labels saved successfully for image ".concat(s))}catch(e){console.error("❌ Error saving labels for image ".concat(s,":"),e)}}}));var W=s(6579),N=s(3214);function T(){let e=(0,a._)(["\n  display: flex;\n  justify-content: space-between;\n  height: 100vh;\n  overflow: hidden;\n"]);return T=function(){return e},e}let V=i.Ay.div(T());function X(){let e=U(e=>e.loadDataset),t=U(e=>e.loadClasses),s=U(e=>e.loadImages),a=U(e=>e.loadLabels),i=U(e=>e.datasets),c=U(e=>e.classes),u=U(e=>e.images),f=U(e=>e.labels),{loading:g,progress:h,loadingStatus:m}=(0,N.A)(),y=U(e=>e.createDataset),v=U(e=>e.saveDataset),p=U(e=>e.deleteDataset),x=U(e=>e.saveClass),I=U(e=>e.deleteClass),b=U(e=>e.saveLabels),w=U(e=>e.saveImage),E=U(e=>e.deleteImage),[C,k]=(0,n.useState)([]),[S,j]=(0,n.useState)([]),[D,A]=(0,n.useState)(!1);(0,n.useEffect)(()=>{e()},[]),(0,n.useEffect)(()=>{s(C)},[C]),(0,n.useEffect)(()=>{t()},[]),(0,n.useEffect)(()=>{a(S)},[S]);let L=(0,n.useMemo)(()=>{let e={};return C.forEach(t=>{Object.entries(u).forEach(t=>{let[s,a]=t;e[s]=a})}),e},[u,C,c]),M=(0,n.useMemo)(()=>Array.from(new Set(C.flatMap(e=>{var t;return(null===(t=i[e])||void 0===t?void 0:t.classIds)||[]}))),[i,C]),[P,_]=(0,n.useState)(!0),[R,B]=(0,n.useState)(!1),[z,T]=(0,n.useState)(null),[X,$]=(0,n.useState)([]),F=(0,n.useRef)(null),H=S.length>0&&u[S[S.length-1]]||null;(0,n.useEffect)(()=>{B(!!H)},[H]),(0,n.useEffect)(()=>{let e=e=>{"Escape"===e.key&&(z&&T(null),$([]))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[z]);let Y=e=>{X.forEach(t=>{if(t.imageId!==(null==z?void 0:z.id))return;let s=c.find(e=>e.id===t.classId);e.strokeStyle=(null==s?void 0:s.color)||"red",e.lineWidth=2,e.strokeRect(t.x,t.y,t.width,t.height)})};return(0,n.useEffect)(()=>{if(!z||!R||!F.current)return;let e=F.current,t=e.previousSibling;t&&(e.width=t.offsetWidth,e.height=t.offsetHeight);let s=e.getContext("2d");s.clearRect(0,0,e.width,e.height),Y(s)},[z,X,c,R]),(0,r.jsxs)(V,{children:[g&&(0,r.jsx)(W.A,{progress:h,status:m}),P&&(0,r.jsx)(l.default,{datasets:i,createDataset:y,removeDataset:p,saveDataset:v,selectedDatasetIds:C,setSelectedDatasetIds:k,setIsSidebarVisible:_}),(0,r.jsx)(o.default,{images:L,saveImage:w,deleteImage:E,selectedDatasetIds:C,classes:c,activeClasses:M,isSidebarVisible:P,setIsSidebarVisible:_,selectedImageIds:S,setSelectedImageIds:j,onImageDoubleClick:e=>{A(!0)}}),R&&H&&(0,r.jsx)(d.default,{isPropertyVisible:R,toggleDrawer:()=>{B(!R),R&&(A(!1),T(null),$([]))},lastClickedImage:H,images:L,selectedDatasetIds:C,selectedImageIds:S,classes:c,activeClasses:M,saveClass:x,deleteClass:I,saveImage:w}),D&&R&&H&&(0,r.jsx)(O,{image:H,classes:c,labels:f,saveLabels:b,onClose:()=>{T(null),A(!1)}})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[266,647,921,757,617,822,520,697,525,980,219,441,517,358],()=>t(2762)),_N_E=e.O()}]);