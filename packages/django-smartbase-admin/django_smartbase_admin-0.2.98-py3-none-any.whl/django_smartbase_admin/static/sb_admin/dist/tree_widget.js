(()=>{const e=function(e,t,n){let o=e.val();void 0!==o&&n.selectAll(!1);let r=[o];if(!0===t.filter){let e=[];r=[];try{e=JSON.parse(o)}catch(t){e=[]}finally{e.forEach((function(e){r.push(e.value)}))}}else if(2===t.multiselect)try{r=JSON.parse(o)}catch(e){r=[]}r.forEach((function(e){let t=n.getNodeByKey(e);t&&(t.getParentList().forEach((function(e){e.setExpanded(!0)})),t.setSelected(!0))}))};$((function(){const t=function(t){if(t.hasClass("fancytree-container"))return;t.on("change",(e=>{const t=e.target.dataset.changeTarget;if(t){const n=document.querySelector(t);n&&(n.value=e.target.value)}}));let n={};const o=e=>{if(!n.isFiltered)return void e.filterNodes((e=>(e.setExpanded(!1),!0)),{autoExpand:!1});const t={};n.data.forEach((e=>t[e.path]=e)),e.filterNodes((e=>{if(t[e.key])return!0}),{autoExpand:!0})},r=$("#"+t.data("tree-data-id")),d=$("#"+t.data("tree-additional-columns-id")),a=$("#"+t.data("tree-strings-id"));let i={},s=[],l={loading:"Loading...",loadError:"Load error!",moreData:"More...",noData:"No data."};try{i=JSON.parse(r.text())||{},s=JSON.parse(d.text())||[],l=JSON.parse(a.text())}catch(e){console.error(e)}const c=$("#"+i.input_id),u=$("#"+i.input_id+"_search"),f=$("#"+i.input_id+"_matches"),p=$("#"+i.input_id+"_label"),h={indentation:32,nodeColumnIdx:0},m=window.loadJSONScriptData("fancytree_filter_settings");i.checkbox&&(h.checkboxColumnIdx=0,h.nodeColumnIdx=1);let v=["table","gridnav","filter"];i.reorder_url&&v.push("dnd5"),t.fancytree({source:{url:i.data_url},extensions:v,checkbox:i.checkbox,selectMode:i.multiselect,dnd5:{preventVoidMoves:!0,preventRecursion:!0,autoExpandMS:400,dropMarkerParent:".tree-list-view",dropMarkerOffsetX:-8,dropMarkerInsertOffsetX:0,dragStart:function(){return!0},dragEnter:function(){return!0},dragDrop:function(e,t){t.otherNode.moveTo(e,t.hitMode)}},filter:{autoApply:!0,autoExpand:!0,counter:!1,fuzzy:!1,hideExpandedCounter:!0,hideExpanders:!0,highlight:!0,leavesOnly:!1,nodata:!0,mode:"hide",...m},table:h,gridnav:{autofocusInput:!1,handleCursorKeys:!0},strings:l,postProcess:function(t,n){setTimeout((function(){e(c,i,n.tree)}),1)},select:function(e,t){if(c.length>0){let e=null;if(i.filter)e=t.tree.getSelectedNodes().map((function(e){return{value:e.key,label:e.title}})),c.val(JSON.stringify(e));else{e=t.tree.getSelectedNodes().map((function(e){return e.key})).join(", "),2===i.multiselect&&(e=JSON.stringify(t.tree.getSelectedNodes().map((function(e){return e.key}))));let n=t.tree.getSelectedNodes().map((function(e){return e.title})).join(", ");p.text(n),c.val(e)}return c[0].dispatchEvent(new CustomEvent("SBAutocompleteChange")),void c[0].dispatchEvent(new Event("change",{bubbles:!0}))}if(i.filter_by_table_data&&t.originalEvent){const e=t.tree.getSelectedNodes().map((function(e){return e.data.id}));document.body.dispatchEvent(new CustomEvent("treeRowSelected",{detail:{data:e}}))}},enhanceTitle:function(e,t){const n=i.reorder_url,o=t.node.rendered,r=t.node.tree.enableFilter,d=i.detail_url,a=t.node.span&&t.node.span.classList.contains("fancytree-node")&&!t.node.tr.classList.contains("fancytree-hide");if(d&&(!o||r)&&!n&&a){const e=t.node.span.querySelector(".fancytree-title"),n=document.createElement("a"),o=i.detail_url.replace(-1,t.node.data.id);n.innerHTML=e.innerHTML,n.classList.add("link"),n.href=o,e.innerHTML="",e.append(n),e.addEventListener("mousedown",(function(e){e.preventDefault(),e.stopPropagation()}),!0)}},renderNode:function(e,t){const n=i.reorder_url,o=t.node.rendered,r=t.node.span&&t.node.span.classList.contains("fancytree-node")&&!t.node.tr.classList.contains("fancytree-hide");if(o&&!n)return;let d=t.node&&t.node.tr&&t.node.tr.classList.contains("fancytree-lastsib");if(d=void 0!==d&&d,t.node.parent?(t.node.treeLevel=t.node.parent.treeLevel+1,t.node.treeAdditionalLevel=[{level:t.node.treeLevel,lastSib:d},...t.node.parent.treeAdditionalLevel]):(t.node.treeLevel=0,t.node.treeAdditionalLevel=[]),t.node.rendered=!0,r){const e=t.node.span.querySelector(".fancytree-expander"),n=t.node.treeLevel,o=t.node.treeAdditionalLevel;e.innerHTML="",e.className="fancytree-expander",e.classList.add("level-"+n),t.node.parent.expanded&&e.classList.add("expanded-parent"),o.forEach(((t,n)=>{if(0!==n&&t.lastSib)return;const o=document.createElement("span");o.classList.add("expander-additional"),0===n&&o.classList.add("expander-additional-last"),o.style.left=-(50+100*n)+"%",e.append(o)}));const r=document.createElement("span");r.classList.add("expander-border"),e.append(r),e.append(document.createElement("div"))}},renderColumns:function(e,t){const n=$(t.node.tr).find(">td");s.forEach((function(e,o){let r=t.node.data[e.key];e.hide_zero&&0===r&&(r=""),n.eq(1+h.nodeColumnIdx+o).html(r)}))},init:function(e,t){i.filter_by_table_data&&o(t.tree)}});const y=function(){u.val(""),f.text(""),g.visit((function(e){e.rendered=!1})),g.clearFilter()},g=$.ui.fancytree.getTree("#"+i.input_id+"_tree");c.on("SBTableFilterFormLoad",(()=>{e(c,i,g)})),c.on("clear",(()=>{g.getSelectedNodes().map((e=>{e.setSelected(!1)}))})),u.on("keyup",(function(e){let t=$(this).val(),n=g.filterNodes(t);e&&e.which===$.ui.keyCode.ESCAPE||""===$.trim(t)?y():f.text("("+n+" matches)")})).trigger("focus"),u.on("search",(function(e){e.target.value||y()})),g.saveTreeOrder=function(){const e=JSON.stringify(g.toDict());fetch(i.reorder_url,{method:"POST",headers:{"X-CSRFToken":window.csrf_token},body:e}).then((e=>e.json())).then((e=>{document.getElementById("notification-messages").innerHTML=e.messages,window.htmx.process(document.getElementById("notification-messages"))}))},i.filter_by_table_data&&(document.body.addEventListener("tableDataProcessed",(e=>{n=e.detail,"loading"!==g.getRootNode().getChildren()[0].statusNodeType&&o(g)})),document.body.addEventListener("treeDeselectAllRows",(()=>{g.selectAll(!1)})),document.body.addEventListener("treeSelectAllRows",(()=>{g.selectAll(!0)})))},n=function(){$(".js-tree-widget").each((function(e,n){const o=$(n);if(o.hasClass("fancytree-container"))return;const r=o.closest(".dropdown-menu");if(r.length>0){const e=function(){t(o),r.prev().off("show.bs.dropdown",e)};r.prev().on("show.bs.dropdown",e)}else t(o)}))};n(),document.addEventListener("formset:added",(()=>{n()}));$(".query-builder-advanced").on("afterCreateRuleInput.queryBuilder",(function(){setTimeout((()=>{n()}),0)}))}))})();