# Working with Regions

Regions are one of the most powerful features in Natural PDF. A region is simply a rectangular area on a page that you can interact with - extract text from it, find elements within it, or generate images of it.

You can create regions in several ways:

1. **Manual creation**: `page.create_region(x0, y0, x1, y1)`
2. **Spatial relations**: `element.above()` or `element.below()`
3. **Content-based**: `element.select_until("another element")`
4. **Structural**: `page.get_sections(start_elements="text:bold")`

## Creating Regions

There are several ways to create regions:

### From an Element

The simplest way to create a region is based on an existing element:

```python
# Get a region below a heading
title = page.find('text:contains("Summary")')
summary_region = title.below()

# Get a region above an element
footer = page.find('text:contains("Page")')
content_region = footer.above()
```

### From One Element to Another

You can create a region spanning from one element to another:

```python
start = page.find('text:contains("Introduction")')
end = page.find('text:contains("Conclusion")')

# Create a region from start to end
content_region = start.until(end)

# This creates a Region object encompassing the area from the top of the 'start'
# element to the bottom of the 'end' element, using their combined horizontal span.
```

### Manually by Coordinates

You can create a region directly using coordinates:

```python
# Create a region from scratch
# (x0, top, x1, bottom)
region = page.create_region(100, 200, 400, 500)
```

### From Layout Analysis

You can get regions detected by document layout analysis:

```python
# Get regions detected by layout analysis
page.analyze_layout()
layout_regions = page.find_all('region')

# Get a specific type of region
tables = page.find_all('region[type=table]')
```

## Working with Regions

Once you have a region, you can:

### Access Region Properties

Regions, especially those generated by layout analysis or sectioning, often have useful properties:

```python
# Assuming 'region' is a Region object (e.g., from page.find_all('region'))
print(f"Region Type: {getattr(region, 'type', 'N/A')}") # e.g., 'table', 'figure', 'text', 'header'
print(f"Confidence: {getattr(region, 'confidence', 'N/A')}") # Confidence score from detection model (0-1)
print(f"Source: {getattr(region, 'source', 'manual')}") # 'detected', 'manual', 'section', etc.
print(f"Label: {getattr(region, 'label', 'N/A')}") # Optional label assigned during creation/detection
```

### Extract Text

```python
# Extract all text from the region
text = region.extract_text()
```

Internally, `region.extract_text()` finds all text elements within the region's bounding box, sorts them in standard reading order (top-to-bottom, left-to-right), and then joins their text content. It automatically respects [Exclusion Zones](#exclusion-zones) defined on the page unless `use_exclusions=False` is specified.

### Find Elements Within the Region

```python
# Find elements within the region
bold_text = region.find_all('text:bold')
```

### Generate an Image of the Region

```python
# Generate an image of just this region
region_image = region.to_image(resolution=150)

# Save it to a file
region.save_image("region.png")

# Options for customization
region.save_image(
    "region_no_border.png", 
    crop_only=True           # Don't add a border
)

region.save_image(
    "region_high_res.png", 
    resolution=300           # Higher resolution
)
```

### Check Relationships with Other Elements/Regions

You can check if an element is inside a region or if two regions overlap.

```python
# Find an element and check if it's within our region
specific_element = page.find('text:contains("Important Note")')
if specific_element and region.contains(specific_element):
    print("The important note is within the main content region.")

# Create another region and check for overlap
sidebar_region = page.create_region(page.width * 0.8, 100, page.width - 10, page.height - 100)
if region.intersects(sidebar_region):
    print("The main content region overlaps with the sidebar region.")
else:
    print("The main content and sidebar regions are separate.")
```

### Modify the Region

You can expand or adjust a region:

```python
# Expand a region in all directions
larger_region = region.expand(left=10, right=10, top=10, bottom=10)

# Expand by a factor
doubled_region = region.expand(width_factor=2, height_factor=2)
```

## Practical Examples

Here are some practical examples of using regions:

### Extract a Section Between Headings

```python
heading1 = page.find('text:contains("Introduction")')
heading2 = page.find('text:contains("Methods")')

# Get the content between the headings
content = heading1.below(until='text:contains("Methods")', include_endpoint=False)
text = content.extract_text()
```

### Extract a Table with its Caption

```python
# Find a table caption
caption = page.find('text:contains("Table 1")')

# Look for the table below the caption
table_region = caption.below(height=200)  # Approximate height

# Extract the table
table_text = table_region.extract_text()
```

### Exclude Headers and Footers

```python
# Define header and footer as exclusion zones
header = page.find('text:contains("CONFIDENTIAL")').above()
footer = page.find('text:contains("Page")').below()

page.add_exclusion(header)
page.add_exclusion(footer)

# Now extract text from a region without the header/footer content
region = page.create_region(50, 100, page.width - 50, page.height - 100)
clean_text = region.extract_text()  # Headers/footers automatically excluded
```

## Exclusion Zones

Exclusion zones allow you to define areas on a page (like headers, footers, or sidebars) that should be ignored during text extraction or element searching.

### Adding Exclusions

You can add exclusions at the page level or for the entire document.

```python
# --- Page-Level Exclusion ---
# Exclude everything above the first line containing "Chapter 1"
chapter_heading = page.find('text:contains("Chapter 1")')
if chapter_heading:
    page.add_exclusion(chapter_heading.above())

# Exclude everything below the last line on the page
last_line = page.find_all('line')[-1]
page.add_exclusion(last_line.below())

# --- PDF-Level Exclusion (using lambda) ---
# Exclude a consistent header on every page
pdf.add_exclusion(
    lambda p: p.find('text:contains("CONFIDENTIAL")').above() if p.find('text:contains("CONFIDENTIAL")') else None,
    label="Confidential Header" # Optional label for debugging
)

# Exclude a consistent footer on every page
pdf.add_exclusion(
    lambda p: p.find('text:contains("Page")').below() if p.find('text:contains("Page")') else None,
    label="Page Footer"
)
```

*Tip:* Using `lambda` functions for PDF-level exclusions allows the exclusion region to be calculated dynamically for each page, adapting to slight variations in header/footer positions.

### How Exclusions are Applied

- **`extract_text()`:** Automatically respects exclusions unless `use_exclusions=False` is passed.
- **`find()` / `find_all()`:** Automatically respect exclusions unless `apply_exclusions=False` is passed.
- Operations *within* a `Region` object also respect the page's exclusions by default when calling `region.extract_text()` or `region.find_all()`.

### Debugging Exclusions

Use the `debug_exclusions=True` flag when extracting text to see how exclusions are being applied:

```python
# Extract text with debug output
text = page.extract_text(debug_exclusions=True)
# >> Page 0: Evaluating 2 exclusions...
# >> Page 0: Applying 2 exclusion regions to 150 elements...
# >> Page 0: Excluded 15 elements, keeping 135.
# >> Page 0: Extracted 1200 characters of text with exclusions applied.
```

## Document Sections

Break down pages or the entire document into logical sections based on recurring elements like headings.

### Page-Level Sections

Use `page.get_sections()` to find sections within a single page.

```python
# Get sections starting with bold text of size 14pt or more
sections = page.get_sections(start_elements='text[size>=14]:bold')

print(f"Found {len(sections)} sections on page {page.number}")

# Process each section
for i, section in enumerate(sections):
    print(f"\n--- Section {i+1} ---")
    # Highlight the section region
    section.highlight(label=f"Section {i+1}")
    
    # Extract text from just this section
    section_text = section.extract_text()
    print(section_text[:100] + "...")

# View the highlighted sections
page.viewer()
```

### Document-Level Sections

Use `pdf.pages.get_sections()` to find sections across multiple pages.

```python
# Get sections across the whole document, starting with bold 14pt+ text
doc_sections = pdf.pages.get_sections(
    start_elements='text[size>=14]:bold',
    new_section_on_page_break=True # Start a new section if a heading is on a new page
)

print(f"Found {len(doc_sections)} sections in the document.")

# Example: Extract text from the first 3 sections
for i, section in enumerate(doc_sections[:3]):
    print(f"\n--- Document Section {i+1} (Page {section.page.number}) ---")
    section_text = section.extract_text()
    print(section_text[:100] + "...")
```

## Next Steps

Now that you know how to work with regions, check out:

- [Visual Debugging](../visual-debugging/index.md) to see what you're extracting
- [OCR](../ocr/index.md) for working with scanned documents
- [Layout Analysis](../layout-analysis/index.md) for automatically detecting regions