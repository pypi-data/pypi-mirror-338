{"version":3,"file":"8063.91bb99bf0baeca18.js","sources":["webpack://knx-frontend/./homeassistant-frontend/src/data/ws-templates.ts","webpack://knx-frontend/./homeassistant-frontend/src/dialogs/config-flow/previews/flow-preview-template.ts"],"sourcesContent":["import type { Connection, UnsubscribeFunc } from \"home-assistant-js-websocket\";\nimport type { HomeAssistant } from \"../types\";\n\nexport interface RenderTemplateResult {\n  result: string;\n  listeners: TemplateListeners;\n}\n\nexport interface RenderTemplateError {\n  error: string;\n  level: \"ERROR\" | \"WARNING\";\n}\n\nexport interface TemplateListeners {\n  all: boolean;\n  domains: string[];\n  entities: string[];\n  time: boolean;\n}\n\nexport type TemplatePreview = TemplatePreviewState | TemplatePreviewError;\n\ninterface TemplatePreviewState {\n  state: string;\n  attributes: Record<string, any>;\n  listeners: TemplateListeners;\n}\n\ninterface TemplatePreviewError {\n  error: string;\n}\n\nexport const subscribeRenderTemplate = (\n  conn: Connection,\n  onChange: (result: RenderTemplateResult | RenderTemplateError) => void,\n  params: {\n    template: string;\n    entity_ids?: string | string[];\n    variables?: Record<string, unknown>;\n    timeout?: number;\n    strict?: boolean;\n    report_errors?: boolean;\n  }\n): Promise<UnsubscribeFunc> =>\n  conn.subscribeMessage(\n    (msg: RenderTemplateResult | RenderTemplateError) => onChange(msg),\n    {\n      type: \"render_template\",\n      ...params,\n    }\n  );\n\nexport const subscribePreviewTemplate = (\n  hass: HomeAssistant,\n  flow_id: string,\n  flow_type: \"config_flow\" | \"options_flow\",\n  user_input: Record<string, any>,\n  callback: (preview: TemplatePreview) => void\n): Promise<UnsubscribeFunc> =>\n  hass.connection.subscribeMessage(callback, {\n    type: \"template/start_preview\",\n    flow_id,\n    flow_type,\n    user_input,\n  });\n","import type { HassEntity, UnsubscribeFunc } from \"home-assistant-js-websocket\";\nimport { LitElement, html, nothing } from \"lit\";\nimport { customElement, property, state } from \"lit/decorators\";\nimport { debounce } from \"../../../common/util/debounce\";\nimport type { FlowType } from \"../../../data/data_entry_flow\";\nimport type {\n  TemplateListeners,\n  TemplatePreview,\n} from \"../../../data/ws-templates\";\nimport { subscribePreviewTemplate } from \"../../../data/ws-templates\";\nimport type { HomeAssistant } from \"../../../types\";\nimport \"./entity-preview-row\";\nimport { fireEvent } from \"../../../common/dom/fire_event\";\nimport \"../../../components/ha-alert\";\n\n@customElement(\"flow-preview-template\")\nclass FlowPreviewTemplate extends LitElement {\n  @property({ attribute: false }) public hass!: HomeAssistant;\n\n  @property({ attribute: false }) public flowType!: FlowType;\n\n  public handler!: string;\n\n  @property({ attribute: false }) public stepId!: string;\n\n  @property({ attribute: false }) public flowId!: string;\n\n  @property({ attribute: false }) public stepData!: Record<string, any>;\n\n  @state() private _preview?: HassEntity;\n\n  @state() private _listeners?: TemplateListeners;\n\n  @state() private _error?: string;\n\n  private _unsub?: Promise<UnsubscribeFunc>;\n\n  disconnectedCallback(): void {\n    super.disconnectedCallback();\n    if (this._unsub) {\n      this._unsub.then((unsub) => unsub());\n      this._unsub = undefined;\n    }\n  }\n\n  willUpdate(changedProps) {\n    if (changedProps.has(\"stepData\")) {\n      this._debouncedSubscribePreview();\n    }\n  }\n\n  protected render() {\n    if (this._error) {\n      return html`<ha-alert alert-type=\"error\">${this._error}</ha-alert>`;\n    }\n    return html`<entity-preview-row\n        .hass=${this.hass}\n        .stateObj=${this._preview}\n      ></entity-preview-row>\n      ${this._listeners?.time\n        ? html`\n            <p>\n              ${this.hass.localize(\"ui.dialogs.helper_settings.template.time\")}\n            </p>\n          `\n        : nothing}\n      ${!this._listeners\n        ? nothing\n        : this._listeners.all\n          ? html`\n              <p class=\"all_listeners\">\n                ${this.hass.localize(\n                  \"ui.dialogs.helper_settings.template.all_listeners\"\n                )}\n              </p>\n            `\n          : this._listeners.domains.length || this._listeners.entities.length\n            ? html`\n                <p>\n                  ${this.hass.localize(\n                    \"ui.dialogs.helper_settings.template.listeners\"\n                  )}\n                </p>\n                <ul>\n                  ${this._listeners.domains\n                    .sort()\n                    .map(\n                      (domain) => html`\n                        <li>\n                          <b\n                            >${this.hass.localize(\n                              \"ui.dialogs.helper_settings.template.domain\"\n                            )}</b\n                          >: ${domain}\n                        </li>\n                      `\n                    )}\n                  ${this._listeners.entities\n                    .sort()\n                    .map(\n                      (entity_id) => html`\n                        <li>\n                          <b\n                            >${this.hass.localize(\n                              \"ui.dialogs.helper_settings.template.entity\"\n                            )}</b\n                          >: ${entity_id}\n                        </li>\n                      `\n                    )}\n                </ul>\n              `\n            : !this._listeners.time\n              ? html`<p class=\"all_listeners\">\n                  ${this.hass.localize(\n                    \"ui.dialogs.helper_settings.template.no_listeners\"\n                  )}\n                </p>`\n              : nothing} `;\n  }\n\n  private _setPreview = (preview: TemplatePreview) => {\n    if (\"error\" in preview) {\n      this._error = preview.error;\n      this._preview = undefined;\n      return;\n    }\n    this._error = undefined;\n    this._listeners = preview.listeners;\n    const now = new Date().toISOString();\n    this._preview = {\n      entity_id: `${this.stepId}.___flow_preview___`,\n      last_changed: now,\n      last_updated: now,\n      context: { id: \"\", parent_id: null, user_id: null },\n      attributes: preview.attributes,\n      state: preview.state,\n    };\n  };\n\n  private _debouncedSubscribePreview = debounce(() => {\n    this._subscribePreview();\n  }, 250);\n\n  private async _subscribePreview() {\n    if (this._unsub) {\n      (await this._unsub)();\n      this._unsub = undefined;\n    }\n    if (this.flowType !== \"config_flow\" && this.flowType !== \"options_flow\") {\n      return;\n    }\n    try {\n      this._unsub = subscribePreviewTemplate(\n        this.hass,\n        this.flowId,\n        this.flowType,\n        this.stepData,\n        this._setPreview\n      );\n      await this._unsub;\n      fireEvent(this, \"set-flow-errors\", { errors: {} });\n    } catch (err: any) {\n      if (typeof err.message === \"string\") {\n        this._error = err.message;\n      } else {\n        this._error = undefined;\n        fireEvent(this, \"set-flow-errors\", err.message);\n      }\n      this._unsub = undefined;\n      this._preview = undefined;\n    }\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"flow-preview-template\": FlowPreviewTemplate;\n  }\n}\n"],"names":["subscribePreviewTemplate","hass","flow_id","flow_type","user_input","callback","connection","subscribeMessage","type","_decorate","customElement","_initialize","_LitElement","FlowPreviewTemplate","constructor","args","F","d","kind","decorators","property","attribute","key","value","state","_superPropGet","this","_unsub","then","unsub","undefined","changedProps","has","_debouncedSubscribePreview","_this$_listeners","_error","html","_t","_","_t2","_preview","_listeners","time","_t3","localize","nothing","all","_t4","domains","length","entities","_t5","sort","map","domain","_t6","entity_id","_t7","_t8","preview","error","listeners","now","Date","toISOString","stepId","last_changed","last_updated","context","id","parent_id","user_id","attributes","debounce","_subscribePreview","flowType","flowId","stepData","_setPreview","fireEvent","errors","err","message","LitElement"],"mappings":"+IAgCO,MAoBMA,EAA2BA,CACtCC,EACAC,EACAC,EACAC,EACAC,IAEAJ,EAAKK,WAAWC,iBAAiBF,EAAU,CACzCG,KAAM,yBACNN,UACAC,YACAC,c,6RC/CqBK,EAAAA,EAAAA,GAAA,EADxBC,EAAAA,EAAAA,IAAc,2BAAwB,SAAAC,EAAAC,GAAvC,MACMC,UAAmBD,EAAoBE,WAAAA,IAAAC,GAAA,SAAAA,GAAAJ,EAAA,OA6J5C,OAAAK,EA7JKH,EAAmBI,EAAA,EAAAC,KAAA,QAAAC,WAAA,EACtBC,EAAAA,EAAAA,IAAS,CAAEC,WAAW,KAAQC,IAAA,OAAAC,WAAA,IAAAL,KAAA,QAAAC,WAAA,EAE9BC,EAAAA,EAAAA,IAAS,CAAEC,WAAW,KAAQC,IAAA,WAAAC,WAAA,IAAAL,KAAA,QAAAI,IAAA,UAAAC,WAAA,IAAAL,KAAA,QAAAC,WAAA,EAI9BC,EAAAA,EAAAA,IAAS,CAAEC,WAAW,KAAQC,IAAA,SAAAC,WAAA,IAAAL,KAAA,QAAAC,WAAA,EAE9BC,EAAAA,EAAAA,IAAS,CAAEC,WAAW,KAAQC,IAAA,SAAAC,WAAA,IAAAL,KAAA,QAAAC,WAAA,EAE9BC,EAAAA,EAAAA,IAAS,CAAEC,WAAW,KAAQC,IAAA,WAAAC,WAAA,IAAAL,KAAA,QAAAC,WAAA,EAE9BK,EAAAA,EAAAA,OAAOF,IAAA,WAAAC,WAAA,IAAAL,KAAA,QAAAC,WAAA,EAEPK,EAAAA,EAAAA,OAAOF,IAAA,aAAAC,WAAA,IAAAL,KAAA,QAAAC,WAAA,EAEPK,EAAAA,EAAAA,OAAOF,IAAA,SAAAC,WAAA,IAAAL,KAAA,QAAAI,IAAA,SAAAC,WAAA,IAAAL,KAAA,SAAAI,IAAA,uBAAAC,MAIR,YACEE,EAAAA,EAAAA,GAtBEZ,EAAmB,8BAsBrBY,CAtBqB,IAuBjBC,KAAKC,SACPD,KAAKC,OAAOC,MAAMC,GAAUA,MAC5BH,KAAKC,YAASG,EAElB,GAAC,CAAAZ,KAAA,SAAAI,IAAA,aAAAC,MAED,SAAWQ,GACLA,EAAaC,IAAI,aACnBN,KAAKO,4BAET,GAAC,CAAAf,KAAA,SAAAI,IAAA,SAAAC,MAED,WAAmB,IAAAW,EACjB,OAAIR,KAAKS,QACAC,EAAAA,EAAAA,IAAIC,IAAAA,EAAAC,CAAA,gCAAgC,gBAAAZ,KAAKS,SAE3CC,EAAAA,EAAAA,IAAIG,IAAAA,EAAAD,CAAA;gBAAA;oBAAA;;QAAA;QAAA,MACCZ,KAAKzB,KACDyB,KAAKc,SAEF,QAAfN,EAAAR,KAAKe,kBAAU,IAAAP,GAAfA,EAAiBQ,MACfN,EAAAA,EAAAA,IAAIO,IAAAA,EAAAL,CAAA;;gBAAA;;aAEEZ,KAAKzB,KAAK2C,SAAS,6CAGzBC,EAAAA,GACDnB,KAAKe,WAEJf,KAAKe,WAAWK,KACdV,EAAAA,EAAAA,IAAIW,IAAAA,EAAAT,CAAA;;kBAAA;;eAEEZ,KAAKzB,KAAK2C,SACV,sDAINlB,KAAKe,WAAWO,QAAQC,QAAUvB,KAAKe,WAAWS,SAASD,QACzDb,EAAAA,EAAAA,IAAIe,IAAAA,EAAAb,CAAA;;oBAAA;;;oBAAA;oBAAA;;iBAEEZ,KAAKzB,KAAK2C,SACV,iDAIAlB,KAAKe,WAAWO,QACfI,OACAC,KACEC,IAAWlB,EAAAA,EAAAA,IAAImB,IAAAA,EAAAjB,CAAA;;;+BAAA;+BAAA;;yBAGPZ,KAAKzB,KAAK2C,SACX,8CAECU,KAIX5B,KAAKe,WAAWS,SACfE,OACAC,KACEG,IAAcpB,EAAAA,EAAAA,IAAIqB,IAAAA,EAAAnB,CAAA;;;+BAAA;+BAAA;;yBAGVZ,KAAKzB,KAAK2C,SACX,8CAECY,MAMhB9B,KAAKe,WAAWC,KAMfG,EAAAA,IALAT,EAAAA,EAAAA,IAAIsB,IAAAA,EAAApB,CAAA;oBAAA;uBACAZ,KAAKzB,KAAK2C,SACV,qDAhDVC,EAAAA,GAoDR,GAAC,CAAA3B,KAAA,QAAAI,IAAA,cAAAC,KAAAA,GAAA,OAEsBoC,IACrB,GAAI,UAAWA,EAGb,OAFAjC,KAAKS,OAASwB,EAAQC,WACtBlC,KAAKc,cAAWV,GAGlBJ,KAAKS,YAASL,EACdJ,KAAKe,WAAakB,EAAQE,UAC1B,MAAMC,GAAM,IAAIC,MAAOC,cACvBtC,KAAKc,SAAW,CACdgB,UAAW,GAAG9B,KAAKuC,4BACnBC,aAAcJ,EACdK,aAAcL,EACdM,QAAS,CAAEC,GAAI,GAAIC,UAAW,KAAMC,QAAS,MAC7CC,WAAYb,EAAQa,WACpBhD,MAAOmC,EAAQnC,MAChB,CACF,IAAAN,KAAA,QAAAI,IAAA,6BAAAC,KAAAA,GAAA,OAEoCkD,EAAAA,EAAAA,IAAS,KAC5C/C,KAAKgD,mBAAmB,GACvB,IAAI,IAAAxD,KAAA,SAAAI,IAAA,oBAAAC,MAEP,iBAKE,GAJIG,KAAKC,gBACAD,KAAKC,UACZD,KAAKC,YAASG,GAEM,gBAAlBJ,KAAKiD,UAAgD,iBAAlBjD,KAAKiD,SAG5C,IACEjD,KAAKC,QAAS3B,EAAAA,EAAAA,GACZ0B,KAAKzB,KACLyB,KAAKkD,OACLlD,KAAKiD,SACLjD,KAAKmD,SACLnD,KAAKoD,mBAEDpD,KAAKC,QACXoD,EAAAA,EAAAA,GAAUrD,KAAM,kBAAmB,CAAEsD,OAAQ,CAAC,GAChD,CAAE,MAAOC,GACoB,iBAAhBA,EAAIC,QACbxD,KAAKS,OAAS8C,EAAIC,SAElBxD,KAAKS,YAASL,GACdiD,EAAAA,EAAAA,GAAUrD,KAAM,kBAAmBuD,EAAIC,UAEzCxD,KAAKC,YAASG,EACdJ,KAAKc,cAAWV,CAClB,CACF,IAAC,GA5J+BqD,EAAAA,I"}