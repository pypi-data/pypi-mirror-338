version: 2.1

deploy_filter: &deploy_filter
  # YAML reference for tag based filtering on deployments
  filters:
    tags:
      only: /^v.*/
    branches:
      ignore: /.*/

jobs:
  run-test:
    docker:
      - image: python:3.8.6

    steps:
      - checkout
      - run:
          name: Install dependencies
          command: pip install virtualenv==20.13.0
      - run:
          name: Run unit tests
          command: make install-with-tests

  deploy:
    docker:
      - image: python:3.8.6

    steps:
      - checkout
      - run:
          name: Install dependencies
          command: pip install virtualenv==20.13.0
      - run:
          name: Deploy to PyPI
          command: make distribute

workflows:
  version: 2

  build:
    jobs:
      - run-test

  deploy:
    jobs:
      - run-test:
          <<: *deploy_filter
      - deploy:
          requires:
            - run-test
          <<: *deploy_filter
