variables:
  HOME: "/tmp"
  UV_CACHE_DIR: .uv_cache
  HATCH_CACHE_DIR: .hatch_cache


stages:
  - test
  - scans
  - build
  - deploy
  - maintenance


include:
  - project: 'jrc-templates/ci-cd/helm'
    ref: master
    file: 'liso/dojo-ci.yaml'
    rules:
      - if: $CI_SERVER_HOST == $PRIVATE_GITLAB

.basic_hatch_job:
  tags:
    - $RUNNER_TAG
  image: bulghao/dev-env:mafw-dev-image@sha256:af6d02c5232cce3fe830c50e7f8b166de5ccfe1579c1ae67d074c53e89065384
  before_script:
    - hatch config set dirs.python /tmp/hatch/python
    - export UV_CACHE_DIR=${CI_PROJECT_DIR}/${UV_CACHE_DIR}
    - export HATCH_CACHE_DIR=${CI_PROJECT_DIR}/${HATCH_CACHE_DIR}
    - mkdir -p ${UV_CACHE_DIR} ${HATCH_CACHE_DIR}
    - if [[ $CI_SERVER_HOST == $PRIVATE_GITLAB ]]; then export HTTPS_PROXY=$PROXY; fi
    - if [[ $CI_SERVER_HOST == $PRIVATE_GITLAB ]]; then export HTTP_PROXY=$PROXY; fi
    - if [[ $CI_SERVER_HOST == $PRIVATE_GITLAB ]]; then export NO_PROXY=$NOPROXY; fi

.basic_maintenance_job:
  tags:
    - $RUNNER_TAG
  image: bulghao/dev-env:mafw-maint_image@sha256:830a1960f8406034eba2bcf991ebed65f10353ca3682add23ec8b310a81ff63a

unittest:
  extends: .basic_hatch_job
  stage: test
  script:
#    - hatch test -c tests/test_active.py
    - hatch test -a -c
    - hatch run hatch-test.py3.11:cov-html
    - hatch run hatch-test.py3.11:cov-xml
  coverage: '/\*\*TOTAL\*\*.*\| \*\*(\d+)%\*\*/'
  artifacts:
    paths:
      - htmlcov/
    expire_in: 1 day
  dependencies: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULED_PIPELINE == "retry"
      when: never
    - if: $CI_PIPELINE_SOURCE != "schedule"
      when: on_success

package_build:
  extends: .basic_hatch_job
  stage: build
  script:
    - hatch build
  artifacts:
    paths:
      - dist/*
    expire_in: 1 day
  dependencies: [ ]
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULED_PIPELINE == "retry"
      when: never
    - if: $CI_PIPELINE_SOURCE != "schedule"
      when: on_success

doc_build:
  extends: .basic_hatch_job
  stage: build
  script:
    - hatch run dev.py3.11:doc clean
    - hatch run dev.py3.11:doc html
    - hatch run dev.py3.11:doc latexpdf
  artifacts:
    paths:
      - docs/build/html/*
      - docs/build/latex/mafw.pdf
    expire_in: 1 day
  dependencies:
    - package_build
  rules:
    - if: $CI_SERVER_HOST == $PRIVATE_GITLAB
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULED_PIPELINE == "retry"
      when: never
    - if: $CI_PIPELINE_SOURCE != "schedule"
      when: on_success

package_local_publish:
  extends: .basic_hatch_job
  stage: deploy
  dependencies:
    - package_build
  script:
    - export HATCH_INDEX_USER=gitlab-ci-token
    - export HATCH_INDEX_AUTH=${CI_JOB_TOKEN}
    - hatch publish --repo ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULED_PIPELINE == "retry"
      when: never
    - if: $CI_COMMIT_TAG && $CI_PIPELINE_SOURCE != "schedule"
      when: on_success

package_pypi_publish:
  extends: .basic_hatch_job
  stage: deploy
  dependencies:
    - package_build
  script:
    - export HATCH_INDEX_USER=__token__
    - export HATCH_INDEX_AUTH=${PYPI_TOKEN}
    - twine check --strict dist/*
    - hatch publish
  rules:
    - if: $CI_SERVER_HOST == $PRIVATE_GITLAB
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULED_PIPELINE == "retry"
      when: never
    - if: $CI_COMMIT_TAG && $CI_PIPELINE_SOURCE != "schedule"
      when: on_success

pages:
  tags:
    - $RUNNER_TAG
  image: debian:latest
  stage: deploy
  pages: true
  dependencies:
    - doc_build
    - unittest
  script:
    - mkdir -p public/doc
    - cp -R docs/build/html/* public/doc
    - cp -R docs/build/latex/mafw.pdf public/doc/mafw.pdf
    - mkdir -p public/coverage
    - cp -R htmlcov/* public/coverage
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_SERVER_HOST == $PRIVATE_GITLAB
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULED_PIPELINE == "retry"
      when: never
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"
      when: on_success

retry_pipelines:
  extends: .basic_maintenance_job
  stage: maintenance
  before_script:
    - export GITLAB_PRIVATE_TOKEN=${SCHEDULED_PIPELINES_TOKEN}
  script:
    - python /usr/local/bin/retry_pipelines.py
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULED_PIPELINE == "retry" && $CI_SERVER_HOST == $PUBLIC_GITLAB
      when: always

sync_public_release:
  extends: .basic_maintenance_job
  stage: deploy
  before_script:
    - if [[ $CI_SERVER_HOST == $PRIVATE_GITLAB ]]; then export HTTPS_PROXY=$PROXY; fi
    - if [[ $CI_SERVER_HOST == $PRIVATE_GITLAB ]]; then export HTTP_PROXY=$PROXY; fi
    - if [[ $CI_SERVER_HOST == $PRIVATE_GITLAB ]]; then export NO_PROXY=$NOPROXY; fi
    - export PRIVATE_GITLAB_TOKEN=${JRC_RELEASE_TOKEN}
    - export PUBLIC_GITLAB_TOKEN=${CEE_RELEASE_TOKEN}
    - echo $CI_COMMIT_TAG
    - echo $HTTP_PROXY
    - export CURL_SSL_VERIFYPEER=0
    - export REQUESTS_CA_BUNDLE=""
    - export PYTHONHTTPSVERIFY=0
    - export GIT_SSL_NO_VERIFY=1
  script:
    - python /usr/local/bin/clone_release.py
  rules:
    - if: $CI_SERVER_HOST == $PRIVATE_GITLAB && $CI_COMMIT_TAG && $CI_PIPELINE_SOURCE != "schedule"
      when: on_success
