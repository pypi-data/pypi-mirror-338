"use strict";(self.webpackChunkjovyan_ai_extension=self.webpackChunkjovyan_ai_extension||[]).push([[493],{755:(e,t,n)=>{n.r(t),n.d(t,{default:()=>N});var o=n(369),r=n(507),l=n(338),c=n(345),a=n.n(c);const i=({onClick:e,text:t})=>{const[n,o]=(0,c.useState)(!1),r=/Mac/i.test(navigator.userAgent),l=r?"⌘K":"^K",i=r?"Cmd+K":"Ctrl+K";return a().createElement("div",{className:"jv-cell-ai-button-container"},a().createElement("button",{className:"jv-cell-ai-button",title:`Generate code ${l}`,onClick:e,onMouseEnter:()=>o(!0),onMouseLeave:()=>o(!1)},t," ",a().createElement("span",{style:{fontSize:"0.8em"}},l)),n&&a().createElement("div",{className:"jv-cell-ai-tooltip"},"Open the prompt box to instruct AI (",i,")"))},s=({onClick:e,text:t})=>{const[n,o]=(0,c.useState)(!1);return a().createElement("div",{className:"jv-cell-fix-error-container"},a().createElement("button",{className:"jv-cell-fix-error-button",title:"Fix Error ⇧F",onClick:e,onMouseEnter:()=>o(!0),onMouseLeave:()=>o(!1)},t," ",a().createElement("span",{style:{fontSize:"0.8em"}},"⇧F")),n&&a().createElement("div",{className:"jv-cell-fix-error-tooltip"},"Fix this error with AI (","Shift+F",")"))};var d=n(880);const u=({onClick:e,disabled:t=!1,className:n,children:o})=>a().createElement("button",{onClick:e,disabled:t,className:n||"jv-default-button",style:{cursor:t?"not-allowed":"pointer",opacity:t?.6:1}},o),m=({isEnabled:e,placeholderEnabled:t,placeholderDisabled:n,initialInput:o,onSubmit:r,onCancel:l})=>{const[i,s]=(0,c.useState)(o||""),m=()=>{""!==i.trim()&&(r(i),s(""))};return a().createElement("div",{className:"jv-cell-ai-input-container"},a().createElement("div",{className:"jv-cell-ai-input-editor"},a().createElement(d.Editor,{defaultLanguage:"markdown",theme:"true"===document.body.getAttribute("data-jp-theme-light")?"vs":"vs-dark",value:i,onChange:e=>{void 0!==e&&s(e)},onMount:(e,t)=>{e.onKeyDown((async t=>{(()=>{const t=e.getContainerDomNode().querySelector(".editor-widget.suggest-widget.visible");return null!==t&&"true"===t.getAttribute("monaco-visible-content-widget")})()||("Escape"===t.code&&(t.preventDefault(),l()),"Enter"===t.code&&(t.preventDefault(),t.shiftKey?e.trigger("keyboard","type",{text:"\n"}):m()))})),e.focus()},options:{minimap:{enabled:!1},lineNumbers:"off",glyphMargin:!1,folding:!1,wordWrap:"on",wrappingIndent:"same",automaticLayout:!0,scrollBeyondLastLine:!1,readOnly:!e,placeholder:e?t:n}})),a().createElement("div",{className:"jv-cell-ai-input-buttons"},a().createElement(u,{onClick:m,disabled:!e||""===i.trim(),className:"jv-cell-ai-input-submit-button"},"Submit",a().createElement("span",{style:{fontSize:"0.7em",marginLeft:"5px"}},"Enter")),a().createElement(u,{onClick:l,className:"jv-cell-ai-input-cancel-button"},"Cancel",a().createElement("span",{style:{fontSize:"0.7em",marginLeft:"5px"}},"Escape"))))};var h=n(24),p=n(195),v=n(963),g=n(576),C=n(608);const f=({onClick:e,className:t,text:n,shortcut:o,tooltip:r})=>{const[l,i]=(0,c.useState)(!1);return a().createElement("div",{className:"jv-cell-diff-review-button-container"},a().createElement("button",{onClick:e,className:t,onMouseEnter:()=>i(!0),onMouseLeave:()=>i(!1),title:`${n} ${o}`},n," ",a().createElement("span",{style:{fontSize:"0.7em"}},o)),l&&a().createElement("div",{className:"tooltip"},r,a().createElement("br",null),"Shortcut: ",a().createElement("strong",null,o)))},y=({buttonsRef:e,onAcceptAndRun:t,onAccept:n,onReject:o})=>((0,c.useEffect)((()=>{e.current&&e.current.focus({preventScroll:!0})}),[]),a().createElement("div",{className:"jv-diff-review-buttons-container",tabIndex:0,ref:e,onKeyDown:e=>{"Enter"===e.key?(e.preventDefault(),e.shiftKey||e.metaKey||e.ctrlKey?e.shiftKey&&document.querySelector(".accept-and-run-button").click():document.querySelector(".accept-button").click()):"m"===e.key&&(e.metaKey||e.ctrlKey)?(e.preventDefault(),document.querySelector(".edit-prompt-button").click()):"Escape"===e.key&&(e.preventDefault(),document.querySelector(".reject-button").click())},onBlur:()=>{e.current&&e.current.focus({preventScroll:!0})}},a().createElement(f,{onClick:t,className:"accept-and-run-button",text:"Accept & Run",shortcut:"Shift + Enter",tooltip:"Accept the changes and run the code in the current cell."}),a().createElement(f,{onClick:o,className:"reject-button",text:"Reject",shortcut:"Escape",tooltip:"Reject the changes and revert to the original code."}),a().createElement(f,{onClick:n,className:"accept-button",text:"Accept",shortcut:"Enter",tooltip:"Accept the changes and keep the code in the current cell."}))),b=({activeCell:e,oldCode:t,generateCodeStream:n,acceptCodeHandler:o,rejectCodeHandler:r,editPromptHandler:l,acceptAndRunHandler:i})=>{const[s,d]=(0,c.useState)(null),[u,m]=(0,c.useState)(null),[f,b]=(0,c.useState)(""),[E,k]=(0,c.useState)(!1),[_,x]=(0,c.useState)("Generating code..."),w=(0,c.useRef)(null);(0,c.useEffect)((()=>{if(e&&void 0!==t){const n=function(e,t,n,o=!1){const r=[(0,g.Hg)(),C.jupyterTheme,h.EditorView.editable.of(!1),p.EditorState.readOnly.of(!0),(0,h.highlightSpecialChars)()];o||r.push((0,v.unifiedMergeView)({original:t,mergeControls:!1,gutter:!1}));const l=new h.EditorView({state:p.EditorState.create({doc:n,extensions:r}),parent:e.editor.dom});return e.editor.dom.classList.add("hidden-editor"),o&&l.dom.classList.add("new-code-generation"),l.dom.classList.add("streaming-now"),e.host.appendChild(l.dom),l}(e.editor,t,t,""===t.trim());d(n)}}),[e,t]),(0,c.useEffect)((()=>{(async()=>{try{m(n)}catch(e){console.error("Error generating code stream:",e),x("Error generating code."),k(!0)}})()}),[n]),(0,c.useEffect)((()=>{u&&(async()=>{try{for await(const e of u)b((t=>t+e));k(!0),x("")}catch(e){console.error("Error processing stream:",e),k(!0),x("")}})()}),[u]),(0,c.useEffect)((()=>{E&&s&&(s.dom.classList.remove("streaming-now"),s.dispatch({changes:{from:0,to:s.state.doc.length,insert:f}}))}),[E,s,f]),(0,c.useEffect)((()=>{E&&w.current&&w.current.scrollIntoView({behavior:"smooth",block:"center"})}),[E]),(0,c.useEffect)((()=>{var n;if(!E&&e&&s){const e=t.split("\n"),o=f.split("\n");if(o.length>1){let t="";t=o.length<e.length?[...o.slice(0,-1),e[o.length-1]+"​",...e.slice(o.length)].join("\n"):f.split("\n").slice(0,-1).join("\n"),s.dispatch({changes:{from:0,to:s.state.doc.length,insert:t}});const r=s.dom.querySelectorAll(".cm-changedLine");r.length>0&&(null===(n=r[r.length-1].previousElementSibling)||void 0===n||n.classList.add("hidden-diff"))}}}),[f,E,e,s,t]);const S=()=>{const t=null==s?void 0:s.dom;t&&t.remove(),e.editor.editor.dom.classList.remove("hidden-editor");const n=w.current;n&&n.remove()};return a().createElement("div",null,_&&a().createElement("p",{className:"status-element"},_),s&&E&&a().createElement(y,{buttonsRef:w,onAcceptAndRun:()=>{i(f),S()},onAccept:()=>{o(f),S()},onReject:()=>{r(),S()},onEditPrompt:()=>{l(f),S()}}))};var E=n(748);let k="wss://backend.jovyan-ai.com",_="",x=new E.JovyanClient(k,_,""),w=!1;const S=async e=>{try{const t=await e.load("jovyan-ai-extension:plugin");k=t.get("backendUrl").composite,_=t.get("authToken").composite}catch(e){console.error("Failed to load settings for jovyan-ai-extension:",e)}try{console.debug("Recreating JovyanClient instance with new settings"),x=new E.JovyanClient(k,_,""),await x.connect();const e=await x.startSession();console.debug("Session ID:",e),console.debug("JovyanClient instance created and connected"),w=!0}catch(e){console.error("Failed to create JovyanClient instance:",e)}},j=e=>{const t=[];if("code"===e.model.type){const n=e.model.outputs;for(let e=0;e<n.length;e++){const o=n.get(e);if(o){const e=o.toJSON();switch(e.output_type){case"execute_result":{const n={output_type:"execute_result",data:e.data};t.push(n);break}case"stream":{const n={output_type:"stream",name:String(e.name||"stdout"),text:Array.isArray(e.text)?e.text.map(String):[String(e.text||"")]};t.push(n);break}case"display_data":{const n={output_type:"display_data",data:e.data};t.push(n);break}case"error":{const n={output_type:"error",ename:String(e.ename||"Error"),evalue:String(e.evalue||"Unknown error"),traceback:Array.isArray(e.traceback)?e.traceback.map(String):[]};t.push(n);break}}}}}return{cell_type:e.model.type,source:e.model.sharedModel.source,outputs:t}};class A{constructor(e,t){this.addCellActivateButton=()=>{this.removeAllActivateButtons();let e="Generate";"code"===this._cell.model.type&&this._cell.model.sharedModel.source&&(e="Modify");const t=document.createElement("div"),n=(0,l.H)(t),o=this._cell.node,r=()=>{this.addPromptInput(),t.remove()},c=a().createElement(i,{onClick:r,text:e});n.render(c),o.appendChild(t),o.hasAttribute("jv-activate-listener")||(o.addEventListener("keydown",(e=>{"k"===e.key&&e.metaKey&&(e.preventDefault(),r())})),o.setAttribute("jv-activate-listener","true"))},this._cell=e,this._notebookController=t}removeAllActivateButtons(){const e=document.querySelector(".jv-cell-ai-button-container");e&&e.remove()}removeCellActivateButton(){const e=this._cell.node.querySelector(".jv-cell-ai-button-container");e&&e.remove()}activate(){console.debug("Activating cell",this._cell.node),this.removeAllActivateButtons(),this.addCellActivateButton(),this.addFixErrorButton()}_checkIsErrorCell(){if("code"!==this._cell.model.type)return!1;const e=this._cell.model;if(0===e.sharedModel.outputs.length)return!1;for(const t of e.sharedModel.outputs)if("error"===t.output_type)return!0;return!1}addFixErrorButton(){if("code"!==this._cell.model.type)return;if(console.debug("Adding fix error button",this._cell.node),this._cell.node.querySelector(".jv-cell-fix-error-container"))return;const e=this._cell.node,t=e.querySelector(".jp-Cell-outputArea");if(!t)return;if(!this._checkIsErrorCell())return;const n=document.createElement("div"),o=(0,l.H)(n),r=async()=>{if(!this._checkIsErrorCell())return;this._checkIsErrorCell();const e=await this.createCodeStream("Fix this error");this.addDiffReview(e),n.remove()},c=a().createElement(s,{onClick:r,text:"Fix Error"});o.render(c),t.appendChild(n),e.hasAttribute("jv-fix-error-listener")||(e.addEventListener("keydown",(e=>{"F"===e.key&&e.shiftKey&&(e.preventDefault(),r())})),e.setAttribute("jv-fix-error-listener","true"))}addPromptInput(){if(this._cell.node.querySelector(".jv-cell-ai-input-container"))return void console.debug("input container already exists");const e=document.createElement("div");e.style.position="relative",e.style.marginTop="10px";const t=a().createElement(m,{isEnabled:!0,placeholderEnabled:"Ask Jovyan",placeholderDisabled:"Input disabled",onSubmit:async e=>{const t=await this.createCodeStream(e);this.addDiffReview(t),this.removePromptInput()},onCancel:()=>{console.debug("Prompt cancelled"),e.remove(),this.addCellActivateButton()}});(0,l.H)(e).render(t),this._notebookController.addElementAfterCellInput(this._cell,e)}removePromptInput(){const e=this._cell.node.querySelector(".jv-cell-ai-input-container");e&&e.remove()}createCodeStream(e){return(async e=>{const t=(()=>{if(!x)throw new Error("JovyanClient instance not initialized");if(!w)throw new Error("JovyanClient instance not connected");return x})();let n=!1;const o=[];return t.generateCodeStream({currentCell:j(e.currentCell),previousCells:e.previousCells.map(j),nextCells:e.nextCells.map(j),prompt:e.userInput,language:e.language,stream:!0},(e=>{o.push(e)})).then((()=>{n=!0})).catch((e=>{throw console.error("Error generating code stream:",e),e})),async function*(){for(;!n||o.length>0;)if(o.length>0){const e=o.shift();e&&(yield e)}else await new Promise((e=>setTimeout(e,50)))}()})({currentCell:this._cell,previousCells:this._notebookController.getPreviousCells(this._cell),nextCells:this._notebookController.getNextCells(this._cell),userInput:e,language:this._notebookController.getLanguage()})}addDiffReview(e){const t=this._cell.node,n=document.createElement("div"),o=(0,l.H)(n),r=a().createElement(b,{activeCell:this._cell,oldCode:this._cell.model.sharedModel.source,generateCodeStream:e,acceptCodeHandler:e=>{this._notebookController.writeCodeInCell(this._cell,e),this.activate()},rejectCodeHandler:()=>{this.activate()},editPromptHandler:e=>{this._notebookController.writeCodeInCell(this._cell,e),this.addPromptInput()},acceptAndRunHandler:e=>{this._notebookController.writeCodeInCell(this._cell,e),this._notebookController.runCell(this._cell),this.activate(),this._notebookController.insertCell(this._notebookController.currentCellIndex+1)}});o.render(r),t.appendChild(n)}}class I{constructor(e,t){this._notebookTracker=e,this._commands=t}get activeCell(){var e;return null===(e=this._notebookTracker.currentWidget)||void 0===e?void 0:e.content.activeCell}addElementAfterCellInput(e,t){const n=e.node,o=n.querySelector(".jp-Cell-inputWrapper");o?o.insertAdjacentElement("afterend",t):n.appendChild(t)}addElementInCellChild(e,t){e.node.appendChild(t)}writeCodeInCell(e,t){e.model.sharedModel.setSource(t)}runCell(e){const t=this._notebookTracker.currentWidget;t&&(t.content.activeCellIndex=t.content.widgets.indexOf(e),this._commands.execute("notebook:run-cell"))}insertCell(e,t){var n;const o=this._notebookTracker.currentWidget;o&&(null===(n=o.model)||void 0===n||n.sharedModel.insertCell(e,{cell_type:"code",source:t}))}get currentCell(){var e;return null===(e=this._notebookTracker.currentWidget)||void 0===e?void 0:e.content.activeCell}get currentCellIndex(){var e;return(null===(e=this._notebookTracker.currentWidget)||void 0===e?void 0:e.content.activeCellIndex)||0}getPreviousCells(e){var t;const n=null===(t=this._notebookTracker.currentWidget)||void 0===t?void 0:t.content,o=null==n?void 0:n.activeCellIndex;return void 0!==o&&n?n.widgets.slice(0,o):[]}getNextCells(e){var t;const n=null===(t=this._notebookTracker.currentWidget)||void 0===t?void 0:t.content,o=this.currentCellIndex;return void 0!==o&&n?n.widgets.slice(o+1):[]}getLanguage(){var e;const t=null===(e=this._notebookTracker.currentWidget)||void 0===e?void 0:e.model;return(null==t?void 0:t.defaultKernelLanguage)||"python"}runCommand(e){this._commands.execute(e)}}const N={id:"jovyan-ai-extension:plugin",description:"A JupyterLab extension to integrate Jovyan AI",autoStart:!0,requires:[o.INotebookTracker],optional:[r.ISettingRegistry],activate:async(e,t,n)=>{console.debug("JupyterLab extension jovyan-ai-extension is activated! Hello!"),n&&(await S(n),n.load("jovyan-ai-extension:plugin").then((e=>{e.changed.connect((async()=>{await S(n)}))})).catch((e=>{console.error("Failed to load settings for jovyan-ai-extension:",e)})));const o=new I(t,e.commands);t.activeCellChanged.connect(((e,t)=>{t&&new A(t,o).activate()}))}}}}]);